---
title: "MissImp Test"
author: "Xuwen Liu"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    number_sections: true
vignette: >
  %\VignetteIndexEntry{"MissImp Test"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r dependencies, message=FALSE, warning=FALSE}
library(stats)
library(MissImp)
knitr::opts_chunk$set(eval = FALSE)
```

# Generate data

We generate a complete data set $(Y_1, ..., Y_8) with (Y_1, Y_2, Y_3) \sim \mathcal{N}(\mu_1, \Sigma_1), (Y_4, Y_5) \sim \mathcal{N}(\mu_2, \Sigma_2), Y_6 \sim P(\lambda)$ and $Y_7, Y_8 \sim \text{Binomial}(p)$.

```{r Generate_complete_dataframe}
complete_df_generator <- function(n) {
  mu.X <- c(1, 2, 3)
  Sigma.X <- matrix(c(
    9, 3, 2,
    3, 4, 0,
    2, 0, 1
  ), nrow = 3)
  X.complete.cont <- MASS::mvrnorm(n, mu.X, Sigma.X) # multivariate normal distribution

  mu1.X <- c(9, 8)
  Sigma1.X <- matrix(c(
    16, 14,
    14, 25
  ), nrow = 2)

  X.complete.cont1 <- MASS::mvrnorm(n, mu1.X, Sigma1.X) # multivariate normal distribution

  lambda <- 4.3
  X.complete.discr <- stats::rpois(n, lambda) # poisson distribution

  X.complete.cat <- stats::rbinom(n, size = 5, prob = 0.4) # binomial

  X.complete.cat2 <- stats::rbinom(n, size = 7, prob = 0.6) # binomial

  X.complete <- data.frame(cbind(X.complete.cont, X.complete.cont1,
    X.complete.discr,
    ... = X.complete.cat, X.complete.cat2
  ))
  X.complete[, 7] <- as.factor(X.complete[, 7])
  levels(X.complete[, 7]) <- c("F", "E", "D", "C", "B", "A")
  X.complete[, 8] <- as.factor(X.complete[, 8])
  colnames(X.complete) <- c("Y1", "Y2", "Y3", "Y4", "Y5", "Y6", "Y7", "Y8")
  return(X.complete)
}
```

We could generate incomplete dataframe from the complete dataframe, with a chosen percentage of missing data and a chosen missing mechanism. The difference between mechanisms is explained in the documentation of \code{generate_miss}.

```{r add_missingness}
n <- 10000
mech <- "MAR1"
miss_prop <- 0.4
X.complete <- complete_df_generator(n)
rs <- generate_miss(X.complete, miss_prop, mechanism = mech)
df <- rs$X.incomp
```

# Summary of imputation

```{r param_setting}
# These parameters need to be chosen wisely. Here the max iteration is set to be small to enable a quick run of model.
col_cat <- c(7:8)
col_dis <- c(6)
n_resample <- 3 # 2*round(log(nrow(df)))
maxiter_tree <- 3
maxiter_pca <- 3
maxiter_mice <- 10
ncp_pca <- 3
learn_ncp <- FALSE
df_complete <- X.complete
num_mi <- 3

imp_method <- "PCA"
resample_method <- "jackknife"
cat_combine_by <- "onehot"
var_cat <- "unalike"
```

```{r MissImp}
res <- MissImp(
  df = df,
  imp_method = imp_method,
  resample_method = resample_method,
  n_resample = n_resample,
  col_cat = col_cat,
  col_dis = col_dis,
  maxiter_tree = maxiter_tree,
  maxiter_pca = maxiter_pca,
  ncp_pca = ncp_pca,
  learn_ncp = learn_ncp,
  cat_combine_by = cat_combine_by,
  var_cat = var_cat,
  df_complete = df_complete,
  num_mi = num_mi,
  maxiter_mice = maxiter_mice
)
```

```{r result_MissImp}
head(df)
head(res$imp)
head(res$imp.disj)
head(res$uncertainty)
head(res$uncertainty.disj)
res$MSE
res$F1
dens_comp(res$imp, X.complete)
```


```{r density_comp_with_mean_imp}
res_mean_imp <- df
col_num <- c(1:6)
col_num_name <- colnames(df)[col_num]
for (y in col_num_name) {
  res_mean_imp[[y]][is.na(res_mean_imp[[y]])] <- mean(res_mean_imp[[y]], na.rm = TRUE)
}


ycol <- "Y3"
X.miss <- X.complete
X.miss[!is.na(df)] <- NA
dat <- data.frame(
  y = c(X.complete[[ycol]], res$imp[[ycol]], res_mean_imp[[ycol]]),
  lines = rep(c("complete", "imputed", "mean_imputed"), each = 10000)
)
dat <- data.frame(
  y = c(X.miss[[ycol]] - res$imp[[ycol]], X.miss[[ycol]] - res_mean_imp[[ycol]]),
  lines = rep(c("imputed_error", "mean_imputed_error"), each = 10000)
)
dat <- data.frame(
  y = c(X.miss[[ycol]], df[[ycol]]),
  lines = rep(c("missing", "observed"), each = 10000)
)
ggplot2::ggplot(dat, ggplot2::aes(x = y, fill = lines)) +
  ggplot2::geom_density(alpha = 0.3) +
  ggplot2::labs(x = ycol)
show(p)
```

# Real data

```{r read_real_data}
credit_data <- read.csv("../inst/extdata/UCI_Credit_data/crx.data", fileEncoding = "UTF-8", dec = ",", header = FALSE)
abalone_data <- read.csv("../inst/extdata/UCI_Abalone_data/abalone.data", fileEncoding = "UTF-8", dec = ",", header = FALSE)
```

```{r preprocessing}
credit_data <- data.frame(credit_data)
col_num <- c(2, 3, 8, 11, 14, 15)
col_dis <- c(11, 14, 15)
col_cat <- c(1, 4, 5, 6, 7, 9, 10, 12, 13, 16)

for (j in col_num) {
  if (j %in% col_dis) {
    suppressWarnings(credit_data[, j] <- as.integer(credit_data[, j]))
  }
  else {
    suppressWarnings(credit_data[, j] <- as.numeric(credit_data[, j]))
  }
}
for (j in col_cat) {
  credit_data[, j][credit_data[, j] == "?"] <- NA
  suppressWarnings(credit_data[, j] <- as.factor(credit_data[, j]))
}
credit_data <- stats::na.omit(credit_data)
row.names(credit_data) <- c(1:nrow(credit_data))
levels(credit_data$V16) <- c("pos", "neg") # remove special symbols
head(credit_data)




abalone_data <- data.frame(abalone_data)
col_num <- c(2:9)
col_dis <- c(9)
col_cat <- c(1)
for (j in col_num) {
  if (j %in% col_dis) {
    suppressWarnings(abalone_data[, j] <- as.integer(abalone_data[, j]))
  }
  else {
    suppressWarnings(abalone_data[, j] <- as.numeric(abalone_data[, j]))
  }
}
for (j in col_cat) {
  abalone_data[, j][abalone_data[, j] == "?"] <- NA
  suppressWarnings(abalone_data[, j] <- as.factor(abalone_data[, j]))
}
abalone_data <- stats::na.omit(abalone_data)
row.names(abalone_data) <- c(1:nrow(abalone_data))
head(abalone_data)
```

```{r rd_param_settings}
mech <- "MNAR1"
miss_prop <- 0.03
X.complete <- abalone_data[,c(c(2:9),1)]
col_cat <- c(9)
col_dis <- c(8)
col_num <- c(1:8)
rs <- generate_miss(X.complete, miss_prop, mechanism = mech)
df <- rs$X.incomp
df_complete <- X.complete
maxiter_tree <- 10
maxiter_pca <- 200
maxiter_mice <- 10
ncp_pca <- round(ncol(df_complete) / 2)
learn_ncp <- FALSE

num_mi <- 4
n_resample <- 4
n_df <- 5

imp_method <- "kNN"
resample_method <- "bootstrap"
cat_combine_by <- "onehot"
var_cat <- "wilcox_va"
```

```{r rd_MissImp}
res <- MissImp(
  df = df, imp_method = imp_method, resample_method = resample_method,
  n_resample = n_resample, col_cat = col_cat, col_dis = col_dis,
  maxiter_tree = maxiter_tree, maxiter_pca = maxiter_pca, ncp_pca = ncp_pca,
  learn_ncp = learn_ncp, cat_combine_by = cat_combine_by, var_cat = var_cat,
  df_complete = df_complete, num_mi = num_mi, maxiter_mice = maxiter_mice
)
head(df)
head(res$imp)
head(res$imp.disj)
head(res$uncertainty)
head(res$uncertainty.disj)
res$MSE
res$F1
dens_comp(res$imp, X.complete)
```

```{r rd_result_MissImp}
i <- 1
result <- list()
for (miss_prop in c(0.005, 0.01, 0.03, 0.05, 0.07, 0.1, 0.3, 0.5)) {
  print(miss_prop)
  rs <- generate_miss(df_complete, miss_prop, mechanism = mech)
  miss_prop_real <- rs$real_miss_perc
  df_incomp <- rs$X.incomp
  result[["mechanisme"]][i] <- mech
  result[["miss_perc"]][i] <- miss_prop_real
  result[["method"]][i] <- imp_method
  result[["resample"]][i] <- resample_method
  res_imp <- MissImp(
    df = df_incomp, imp_method = imp_method, resample_method = resample_method,
    n_resample = n_resample, col_cat = col_cat, col_dis = col_dis,
    maxiter_tree = maxiter_tree, maxiter_pca = maxiter_pca, ncp_pca = ncp_pca,
    learn_ncp = learn_ncp, cat_combine_by = cat_combine_by, var_cat = var_cat,
    df_complete = df_complete, num_mi = num_mi, maxiter_mice = maxiter_mice
  )
  result[["MSE"]][i] <- res_imp$MSE$Mean_MSE
  result[["Var_MSE"]][i] <- res_imp$MSE$Variance_MSE
  result[["F1"]][i] <- res_imp$F1$Mean_F1
  result[["Var_F1"]][i] <- res_imp$F1$Variance_F1
  result[["scaled_MSE"]][i] <- res_imp$MSE$Mean_MSE_scale
  result[["Var_scaled_MSE"]][i] <- res_imp$MSE$Variance_MSE_scale
  i <- i + 1
}

data.frame(result)
```


```{r different_miss_proportion}
i <- 1
result <- list()
for (miss_prop in c(0.005, 0.01, 0.03, 0.05, 0.07, 0.1, 0.3, 0.5)) {
  print(miss_prop)
  miss_prop_real <- c()
  ls_mse <- c()
  ls_test_mse <- c()
  ls_scared_mse <- c()
  ls_f1 <- c()
  ls_seed <- sample(1:100, n_df, replace = TRUE)
  for (j in seq(n_df)) {
    set.seed(ls_seed[j])
    rs <- generate_miss(df_complete, miss_prop, mechanism = mech, mar2.col.ctrl = 2)
    miss_prop_real <- c(miss_prop_real,rs$real_miss_perc)
    df_incomp <- rs$X.incomp
    res_imp <- MissImp(
      df = df_incomp, imp_method = imp_method,
      resample_method = resample_method, n_resample = n_resample,
      col_cat = col_cat, col_dis = col_dis,
      maxiter_tree = maxiter_tree, maxiter_pca = maxiter_pca,
      ncp_pca = ncp_pca, learn_ncp = learn_ncp,
      cat_combine_by = cat_combine_by, var_cat = var_cat,
      df_complete = df_complete, num_mi = num_mi,
      maxiter_mice = maxiter_mice
    )
    ls_mse <- c(ls_mse, res_imp$MSE$Mean_MSE)
    ls_scared_mse <- c(ls_scared_mse, res_imp$MSE$Mean_MSE_scale)
    ls_f1 <- c(ls_f1, res_imp$F1$Mean_F1)

    num_colnames <- colnames(df_complete)[col_num]
    ximp_num <- res_imp$imp[num_colnames]
    xcomp_num <- df_complete[num_colnames]
    test_MSE <- sum((xcomp_num - ximp_num) * (xcomp_num - ximp_num)) / sum(rs$R.mask[col_num] * 1)
    ls_test_mse <- c(ls_test_mse, test_MSE)
  }

  result[["mechanisme"]][i] <- mech
  result[["miss_perc"]][i] <- mean(miss_prop_real)
  result[["method"]][i] <- imp_method
  result[["scaled_MSE"]][i] <- mean(ls_scared_mse)
  result[["Var_scaled_MSE"]][i] <- var(ls_scared_mse)
  result[["test_MSE"]][i] <- mean(ls_test_mse)
  result[["Var_test_MSE"]][i] <- var(ls_test_mse)
  result[["MSE"]][i] <- mean(ls_mse)
  result[["Var_MSE"]][i] <- var(ls_mse)
  result[["F1"]][i] <- mean(ls_f1)
  result[["Var_F1"]][i] <- var(ls_f1)
  i <- i + 1
}
data.frame(result)
```

```{r rd_write_csv}
library(ggplot2)
# write.csv(result,"test1_MNAR1_kNN_boot_result.csv")
res <- read.csv("test1_MAR2_EM_boot_result.csv")
x <- res$miss_perc
y1 <- res$scaled_MSE
y2 <- res$scaled_MSE + 1.96 * sqrt(res$Var_scaled_MSE)
y3 <- res$scaled_MSE - 1.96 * sqrt(res$Var_scaled_MSE)
#
# plot(x, y1, type = "n", ylim = range(c(y1, y2)), xlab = "", ylab = "")
# lines(x, y1, col = "blue")
# lines(x, y2, col = "red")
# lines(x, y3, col = "red")
predframe <- with(res, data.frame(miss_perc,
  scaled_MSE = scaled_MSE,
  lwr = scaled_MSE - 1.96 * sqrt(Var_scaled_MSE),
  upr = scaled_MSE + 1.96 * sqrt(Var_scaled_MSE)
))
p1 <- ggplot(predframe, aes(miss_perc, scaled_MSE)) +
  geom_point() +
  geom_line(data = predframe) +
  geom_ribbon(data = predframe, aes(ymin = lwr, ymax = upr), alpha = 0.3, fill = "red") +
  xlab("Percentage of missing data")
show(p1)
```
